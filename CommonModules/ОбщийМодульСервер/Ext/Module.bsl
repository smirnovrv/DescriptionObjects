
//Структура 
//Структура "Сервер"			,ИмяСервера);
//Структура "База"				,ИмяБазы);
//Структура "Пользователь"		,ИмяПользователя);
//Структура "Пароль"			,Пароль);
//
Функция ПодключитьсяКбазе(Структура) Экспорт
	
	СтрокаПодключения = "Srvr="+Структура.Сервер+"; Ref="+Структура.База+"; Usr="+Структура.Пользователь+"; Pwd="+Структура.Пароль+";";
	ПараметрыПодключенияКлиентСервернойИБ = СтрокаПодключения;
	//"Srvr=serv1c; Ref=buh_51346332; Usr=roman; Pwd=roman;";
	
	V83COMCon = Новый COMОбъект("V83.COMConnector");
	Попытка
		Возврат V83COMCon.Connect(ПараметрыПодключенияКлиентСервернойИБ);
	Исключение
		Сообщить(ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции 

Функция ПодключитьсяКТекущейбазе(Ссылка) Экспорт
	
	Структура = Новый Структура;
	Структура.Вставить("Сервер"			,Ссылка.ИмяСервера);
	Структура.Вставить("База"			,Ссылка.ИмяБазы);
	Структура.Вставить("Пользователь"	,Ссылка.ИмяПользователя);
	Структура.Вставить("Пароль"			,Ссылка.Пароль);
	
	Соединение = ОбщийМодульСервер.ПодключитьсяКбазе(Структура);  
	
	Возврат Соединение;
КонецФункции

//Ссылка - Ссылка на Объект
//ИБ 	 - СОМ соединение
//
Процедура ЗаполнитьРеквизитыОбъекта(Ссылка, ИБ) Экспорт
		
	СпрОбъект = Ссылка.ПолучитьОбъект(); 	
	СпрОбъект.рс_Реквизиты.Очистить(); 
	
	Соединение = ПодключитьсяКТекущейбазе(ИБ);
	
	Структура = Новый Структура; 
	Структура.Вставить("тВид"	, Строка(СпрОбъект.Вид));
	Структура.Вставить("ИД"		, СпрОбъект.Индентификатор);
	Структура.Вставить("Табл"	, СпрОбъект.рс_Реквизиты);
	Структура.Вставить("ТЧ"		, Неопределено); 
	Структура.Вставить("ИБ"		, Соединение);
	
	ЗаполнитьРеквизиты(Структура); 
	
	Для Каждого Метаданное Из Соединение.Метаданные[Структура.тВид][Структура.ИД].ТабличныеЧасти Цикл 
		ИмяТЧ = Метаданное.Имя;
		ТабЧасть =  Справочники.рс_ТабличныеЧасти.НайтиПоНаименованию(ИмяТЧ);
		
		Если Не ЗначениеЗаполнено(ТабЧасть) Тогда 
			ТабЧасть = Создать_ТабличныеЧасти(ИмяТЧ, Метаданное.Синоним);
		КонецЕсли;
		
		Структура.Вставить("ТЧ"		, ТабЧасть);
		
		ЗаполнитьРеквизиты(Структура);
	КонецЦикла;	
	
	СпрОбъект.рс_Формы.Очистить(); 
	Для Каждого Метаданное Из Соединение.Метаданные[Структура.тВид][Структура.ИД].Формы Цикл 
		 ИмяФормы = Метаданное.Имя; 
		 текФорма =  Справочники.рс_Формы.НайтиПоНаименованию(ИмяФормы);
		 
		 Если Не ЗначениеЗаполнено(текФорма) Тогда 
			текФорма = Создать_Форму(ИмяФормы, Метаданное.Синоним);
		КонецЕсли; 
		
		НоваяСтрока = СпрОбъект.рс_Формы.Добавить();
		НоваяСтрока.рс_Форма = текФорма;
	КонецЦикла;
	
	СпрОбъект.рс_Команды.Очистить(); 
	Для Каждого Метаданное Из Соединение.Метаданные[Структура.тВид][Структура.ИД].Команды Цикл 
		ИмяКоманды 	= Метаданное.Имя; 
		текКоманда 	=  Справочники.рс_Команды.НайтиПоНаименованию(ИмяКоманды);
		 
		Если Не ЗначениеЗаполнено(текКоманда) Тогда 
			текКоманда = Создать_Команду(ИмяКоманды, Метаданное.Синоним);
		КонецЕсли; 
		
		НоваяСтрока = СпрОбъект.рс_Команды.Добавить();
		НоваяСтрока.рс_Команда = текКоманда;
	КонецЦикла;  
	
	СпрОбъект.Записать();
		
КонецПроцедуры     

//	Структура "тВид"	, Строка(СпрОбъект.Вид));
//	Структура "ИД"		, СпрОбъект.Индентификатор);
//	Структура "Табл"	, СпрОбъект.рс_Реквизиты);
//	Структура "ТЧ"		, Неопределено); 
//	Структура "ИБ"		, ИБ);
//
Процедура ЗаполнитьРеквизиты(Структура) Экспорт 
     ИБ = Структура.ИБ; 
	 
	Для Каждого Метаданное Из ИБ.Метаданные[Структура.тВид][Структура.ИД].Реквизиты Цикл 
		НовСтрока = Структура.Табл.Добавить(); 
		НовСтрока.РеквизитСиноним 	= Метаданное.Синоним;
		НовСтрока.РеквизитИмя 		= Метаданное.Имя;
		
		Если Не Структура.ТЧ = Неопределено Тогда 
			НовСтрока.рс_ТабличнаяЧасть = Структура.ТЧ;
		КонецЕсли;	
		
		ТипыР = Метаданное.Тип.Типы(); 
		ТипР = "";
		
		//--Временно пока не понятно как--
		//
		//Для Каждого стрТип Из ТипыР Цикл 			
		//	ПоискТип = Метаданные.НайтиПоТипу(стрТип);
		//	Если ПоискТип = Неопределено Тогда 
		//		РеквизитТип 		= Метаданное.Тип;	
		//	Иначе 	
		//		ТипР = ТипР + ?(ТипР = "","","; ") + Метаданные.НайтиПоТипу(стрТип).ПолноеИмя();
		//		РеквизитТип = ТипР;		
		//	КонецЕсли;
		//КонецЦикла;
		//
		//НовСтрока.РеквизитТип 			= РеквизитТип; 		 
		НовСтрока.ПроверкаЗаполнения 	= Метаданное.ПроверкаЗаполнения = ПроверкаЗаполнения.ВыдаватьОшибку; 			
	
	КонецЦикла;

КонецПроцедуры

Функция Создать_ТабличныеЧасти(ИмяТЧ, Синоним)
	 СправочникСсылка = Справочники.рс_ТабличныеЧасти.ПустаяСсылка();
	 
	 СправочникОбъект = Справочники.рс_ТабличныеЧасти.СоздатьЭлемент();
	 СправочникОбъект.Наименование 		= Синоним;     
	 СправочникОбъект.Индентификатор  	= ИмяТЧ;
	 СправочникОбъект.Записать();
	 СправочникСсылка = СправочникОбъект.Ссылка;
	 
	 Возврат СправочникСсылка; 
	 
 КонецФункции
 
Функция Создать_Форму(ИмяФормы, Синоним)
	 СправочникСсылка = Справочники.рс_Формы.ПустаяСсылка();
	 
	 СправочникОбъект = Справочники.рс_Формы.СоздатьЭлемент();
	 СправочникОбъект.Наименование 		= Синоним;
	 СправочникОбъект.Индентификатор    = ИмяФормы; 
	 СправочникОбъект.Записать();
	 СправочникСсылка = СправочникОбъект.Ссылка;
	 
	 Возврат СправочникСсылка; 
	 
 КонецФункции
 
Функция Создать_Команду(ИмяКоманды, Синоним)
	 СправочникСсылка = Справочники.рс_Команды.ПустаяСсылка();
	 
	 СправочникОбъект = Справочники.рс_Команды.СоздатьЭлемент();
	 СправочникОбъект.Наименование 		= Синоним;
	 СправочникОбъект.Индентификатор    = ИмяКоманды; 
	 СправочникОбъект.Записать();
	 СправочникСсылка = СправочникОбъект.Ссылка;
	 
	 Возврат СправочникСсылка; 
	 
 КонецФункции

Функция НайтиСправочникОбъект(Наименование) Экспорт
	
	СправочникСсылка = Справочники.рс_Объекты.ПустаяСсылка();
	
	 СправочникСсылка = Справочники.рс_Объекты.НайтиПоНаименованию(Наименование);
	
	Возврат СправочникСсылка; 
	
КонецФункции	 

Функция НайтиОбъект(Тип, Наименование) Экспорт
	
	Если Тип = "Catalogs" Тогда 
		Вид = Перечисления.рс_ВидОбъектов.Справочники;
	Иначе
		Вид = Тип; 
	КонецЕсли;
	
	СправочникСсылка = Справочники.рс_Объекты.ПустаяСсылка();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	рс_Объекты.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.рс_Объекты КАК рс_Объекты
		|ГДЕ
		|	рс_Объекты.Вид = &Вид
		|	И рс_Объекты.Наименование = &Наименование";
	
	Запрос.УстановитьПараметр("Вид", Вид);
	Запрос.УстановитьПараметр("Наименование", Наименование);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		  СправочникСсылка  = ВыборкаДетальныеЗаписи.Ссылка;
	КонецЦикла;
		
	Возврат СправочникСсылка; 
	
КонецФункции

Функция СоздатьОбъект(Структура)  Экспорт 
	
	Нов_Объект = Справочники.рс_Объекты.СоздатьЭлемент();	
	Нов_Объект.Индентификатор 		= Структура.Индентификатор;
	Нов_Объект.Наименование  		= Структура.Наименование; 
	Нов_Объект.Вид            		= Структура.Вид;
	Нов_Объект.Подсистема     		= Структура.Подсистема;
	Нов_Объект.ИнформационнаяБаза 	= Структура.СправочникИБ;
	Нов_Объект.Изменен              = Перечисления.рс_Изменения.Типовой;
	Нов_Объект.Записать();
	
	ЗаполнитьРеквизитыОбъекта(Нов_Объект.Ссылка, Структура.СправочникИБ);

	Возврат Нов_Объект.Ссылка;
	
КонецФункции 
